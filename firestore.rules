rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isAdmin() {
      return request.auth.token.email == 'admin@dana-academy.com';
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isUserAuthenticated() {
      return request.auth != null;
    }

    // --- Students Collection Rules ---
    // Only admin can create, update, or delete students.
    // Any authenticated user can read student data (needed for admin panel).
    match /students/{studentId} {
      allow read: if isUserAuthenticated();
      allow write: if isAdmin();
    }

    // --- Pending Devices Collection Rules ---
    // A student can create a pending device request for themselves.
    // Only admin can read or delete pending requests.
    match /pendingDevices/{deviceId} {
      allow create: if isUserAuthenticated() && isOwner(request.resource.data.studentId);
      allow read, delete: if isAdmin();
    }

    // --- Registered Devices Collection Rules ---
    // An admin can perform any action.
    // A student can only read devices registered to their own ID.
    match /registeredDevices/{deviceId} {
      allow read: if isAdmin() || (isUserAuthenticated() && isOwner(resource.data.studentId));
      allow write: if isAdmin();
    }
  }
}
