
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if the user is an admin
    function isAdmin() {
      return request.auth != null && request.auth.token.email == 'admin@dana-academy.com';
    }

    // Students can only read their own data.
    // Admins can read, list, and write all student data.
    match /students/{studentId} {
      allow read: if request.auth != null && (request.auth.uid == studentId || isAdmin());
      allow list, create, update, delete: if isAdmin();
    }
    
    // Any authenticated user can create a pending device request for themselves.
    // Admins can read, list, and delete pending devices.
    match /pendingDevices/{deviceId} {
      allow create: if request.auth != null && request.resource.data.studentId == request.auth.uid;
      allow read, list, delete: if isAdmin();
    }
    
    // Students can read their own registered devices.
    // Admins can read, list, create, and delete all registered devices.
    match /registeredDevices/{deviceId} {
       allow read: if request.auth != null && get(/databases/$(database)/documents/registeredDevices/$(deviceId)).data.studentId == request.auth.uid;
       allow list, create, delete: if isAdmin();
    }
  }
}

    